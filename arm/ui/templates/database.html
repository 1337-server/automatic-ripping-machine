{% extends "base.html" %}
{% block title %}Database{% endblock %}
{% block nav %}{{ super() }}{% endblock %}

{% block content %}

    <div class="container-fluid h-100 mx-auto">
        <div class="row">
            <div class="col-sm-12  rounded text-center">
                <img src="static/img/arm80.png" alt="Automatic Ripping Machine">
                <p class="text-center">
                    <strong>Welcome to your Automatic Ripping Machine<br></strong>
                </p>
            </div>
        </div>
        <div class="row h-100 mx-auto align-items-center">
            <div class="col-sm-12 mx-auto">
                <p class="text-center">
                    <h5 class="text-center"><strong>Database Entries</strong></h5>
                </p>
            </div>
        </div>
        <!-- Modal -->
        <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle"
             aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLongTitle">Search Database</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="searchlabel">Search </span>
                            </div>
                            <input type="text" class="form-control" id="searchquery" aria-label="searchquery"
                                   name="searchquery" placeholder="Search...." value="" aria-describedby="searchlabel">
                            <div id="validationServer03Feedback" class="invalid-feedback">
                                Search string too short.
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button id="save-no" type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
                        <button id="save-yes" type="button" class="btn btn-primary">Yes</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="message1" class="alert alert-success d-none" role="alert">
            <h4 class="alert-heading">Job was deleted successfully</h4>
        </div>

        <div id="message2" class="alert alert-danger text-center">
            <strong>WARNING: </strong>There is no undo here!
            <br>Be careful!
        </div>

        <div id="message3" class="alert alert-danger d-none" role="alert">
            <h4 class="alert-heading">There was a problem with your request</h4>
            <p>There was a problem with your request. Check the ARMui log for more details.</p>
        </div>

        <div class="row d-flex justify-content-end">
            <div class="p-4">
                <button id="save-get-success" type="button" class="btn btn-secondary btn-success">Get all successful
                    jobs
                </button>
                <button id="save-get-failed" type="button" class="btn btn-secondary btn-danger">Get all failed jobs
                </button>
                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal"
                        data-type="search" data-href="json?mode=search&q=">Search Database
                </button>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <p class="text-left mt-3 d-block">Showing page {{ pages.page }} of {{ pages.pages }}</p>
            </div>
            <!-- Pagination Links-->
            <div class="col text-right">
                <a href="{{ url_for('database', page=pages.prev_num) }}"
                   class="btn btn-primary {% if pages.page == 1 %}disabled{% endif %}">&laquo;</a>
                <!-- Loop through the number of pages to display a link for each-->
                {% for page_num in pages.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                    {% if page_num %}
                        <!-- Check for the active page and set the link to "Active"-->
                        {% if pages.page == page_num %}
                            <a href="{{ url_for('database', page=page_num) }}"
                               class="btn btn-secondary active">{{ page_num }}</a>
                        {% else %}
                            <a href="{{ url_for('database', page=page_num) }}"
                               class="btn btn-primary">{{ page_num }}</a>
                        {% endif %}
                    {% else %}
                        ...
                    {% endif %}
                {% endfor %}
                <a href="{{ url_for('database', page=pages.next_num) }}"
                   class="btn btn-primary {% if pages.page == pages.pages %}disabled{% endif %}">&raquo;</a>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12 mx-auto">
                <div class="card-deck">
                    {% for job in jobs %}
                        <div class="col-md-4" id="jobId{{ job.job_id }}">
                            <div class="card mb-3  mx-auto">
                                <div class="card-header row no-gutters justify-content-center">
                                    <strong>{% if not job.title_manual %}
                                        {{ job["title"] }} {{ '('+job['year']+')' if job["year"] is not none }}
                                    {% else %}
                                        {{ job["title_manual"] }} {{ '('+job['year']+')' if job["year"] is not none }}
                                    {% endif %}
                                    </strong>
                                </div>
                                <div class="row no-gutters">
                                    <div class="col-lg-4">
                                        {% if not job.poster_url %}
                                            <a href="jobdetail?job_id={{ job.job_id }}"><img src="static/img/none.png"
                                                                                             width="240px"
                                                                                             class="img-thumbnail"
                                                                                             alt="No Poster Image"></a>
                                        {% else %}
                                            <a href="jobdetail?job_id={{ job.job_id }}"><img src="{{ job.poster_url }}"
                                                                                             width="240px"
                                                                                             class="img-thumbnail"
                                                                                             alt="Poster image"></a>
                                        {% endif %}
                                    </div>
                                    <div class="col-lg-4">
                                        <div class="card-body px-1 py-1">
                                            <strong>Type: </strong> {{ job.video_type }} <br>
                                            {% if not job.title_manual %}
                                                <strong>Year: </strong>({{ job["year"] }})<br>
                                            {% else %}
                                                <del><strong>Year:
                                                </strong>{{ job["year_auto"] }}<br></del>
                                                <strong>Year: </strong> {{ job["year"] }}<br>
                                            {% endif %}
                                            <strong>Device: </strong>{{ job.devpath }}<br>
                                            <strong>Status: </strong><img id="status{{ job.job_id }}"
                                                                          src="static/img/{{ job.status }}.png"
                                                                          height="20px"
                                                                          alt="{{ job.status }}"
                                                                          title="{{ job.status }}"><br>
                                            <strong>Start Date:</strong>{{ job.start_time.strftime(date_format) if
                                    job.start_time is not none }}<br>
                                            <strong>Start Time:</strong>{{ job.start_time.strftime("%H:%M:%S") if job.start_time
                                    is not none }}<br>
                                            <strong>Job Time:</strong>{{ job.job_length }}<br>
                                            {% if job.status == "transcoding" %}
                                                <div class="progress">
                                                    <div class="progress-bar progress-bar-striped progress-bar-animated"
                                                         role="progressbar" aria-valuenow="{{ job.progress_round }}"
                                                         aria-valuemin="0" aria-valuemax="100"
                                                         style="width: {{ job.progress_round }}%;">
                                                        <small class="justify-content-center d-flex position-absolute w-100"><strong>Progress: </strong>{{ job.progress }}%</small>
                                                    </div>
                                                </div>
                                                <strong>ETA: </strong>{{ job.eta }} <br>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-lg-4">
                                        <div class="card-body px-1 py-1">
                                            <div id="jobId{{ job.job_id }}_RIPMETHOD"><strong>Rip
                                                Method: </strong>{{ job.config.RIPMETHOD }}</div>
                                            <div id="jobId{{ job.job_id }}_MAINFEATURE"><strong>Main
                                                Feature: </strong>{{ job.config.MAINFEATURE }}</div>
                                            <div id="jobId{{ job.job_id }}_MINLENGTH"><strong>Min
                                                Length: </strong>{{ job.config.MINLENGTH }}</div>
                                            <div id="jobId{{ job.job_id }}_MAXLENGTH"><strong>Max
                                                Length: </strong>{{ job.config.MAXLENGTH }}</div>
                                        </div>
                                        <div class="card-body px-2 py-1">
                                            <div class="btn-group-vertical" role="group" aria-label="buttons">
                                                <button type="button" class="btn btn-primary" data-toggle="modal"
                                                        data-target="#exampleModal" data-type="abandon"
                                                        data-jobid="{{ job.job_id }}"
                                                        data-href="json?job={{ job.job_id }}&mode=abandon">Abandon Job
                                                </button>
                                                <button type="button" class="btn btn-primary" data-toggle="modal"
                                                        data-target="#exampleModal" data-type="delete"
                                                        data-jobid="{{ job.job_id }}"
                                                        data-href="json?job={{ job.job_id }}&mode=delete">Delete Job
                                                </button>
                                                <button type="button" class="btn btn-primary" data-toggle="modal"
                                                        data-target="#exampleModal" data-type="log"
                                                        data-jobid="{{ job.job_id }}"
                                                        data-href="json?logfile={{ job.logfile }}&mode=full&job={{ job.job_id }}">
                                                    View Logfile
                                                </button>
                                                <button type="button" class="btn btn-primary" data-toggle="modal"
                                                        data-target="#exampleModal" data-type="fixperms"
                                                        data-jobid="{{ job.job_id }}"
                                                        data-href="json?mode=fixperms&job={{ job.job_id }}">Fix
                                                    Permissions
                                                </button>

                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <p class="text-left mt-3 d-block">Showing page {{ pages.page }} of {{ pages.pages }}</p>
            </div>
            <!-- Pagination Links-->
            <div class="col text-right">
                <a href="{{ url_for('database', page=pages.prev_num) }}"
                   class="btn btn-primary {% if pages.page == 1 %}disabled{% endif %}">&laquo;</a>
                <!-- Loop through the number of pages to display a link for each-->
                {% for page_num in pages.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                    {% if page_num %}
                        <!-- Check for the active page and set the link to "Active"-->
                        {% if pages.page == page_num %}
                            <a href="{{ url_for('database', page=page_num) }}"
                               class="btn btn-secondary active">{{ page_num }}</a>
                        {% else %}
                            <a href="{{ url_for('database', page=page_num) }}"
                               class="btn btn-primary">{{ page_num }}</a>
                        {% endif %}
                    {% else %}
                        ...
                    {% endif %}
                {% endfor %}
                <a href="{{ url_for('database', page=pages.next_num) }}"
                   class="btn btn-primary {% if pages.page == pages.pages %}disabled{% endif %}">&raquo;</a>
            </div>
        </div>

    </div>

{% endblock %}
{% block footer %}{{ super() }}{% endblock %}
{% block js %}
    {{ super() }}

    <script type="application/javascript">
        activeTab("database");
    </script>
    <script type="application/javascript" src="static/js/database.js"></script>
{% endblock %}
